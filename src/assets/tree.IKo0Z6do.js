import{_ as j,B as C}from"./Button.DLsEGMw6.js";import{r as p,a6 as le,v as R,a7 as q,B as d,A as o,C as I,z as ae,_ as oe,c as se,b9 as re,x as de,y as ie,E as i,a$ as M,ab as ue,g as b,a3 as ce}from"./entry.B79t8160.js";import{_ as pe,a as fe}from"./FormItem.C3DR4S6Q.js";import{_ as F,N as ge,a as me}from"./Tree.cVHN8enr.js";import{_ as T}from"./Space.CoyloG0X.js";import{_ as ve}from"./Card.t-T5tsO1.js";import{_ as G}from"./Modal.CeSbMG6K.js";import{I as z}from"./iconify.BCVX6Ifv.js";import{S as _e}from"./Scrollbar.DfppsR0A.js";import{u as be}from"./use-message.BH-wgOTP.js";const he={__name:"normalModal",props:{show:Boolean,editMode:Boolean,organization:Object,parentId:String||Number},emits:["update:show","submit"],setup(w,{emit:K}){const m=w,B=K,v=p(null),c=p(!1),u=p({label:"",description:"",parentId:null}),A={label:{required:!0,message:"请输入组织名称",trigger:"blur"},description:{required:!0,message:"请输入组织描述",trigger:"blur"}};le(()=>m.show,_=>{_&&(m.editMode&&m.organization?u.value={...m.organization}:u.value={label:"",description:"",parentId:m.parentId||null})},{immediate:!0});const O=_=>{var n;_.preventDefault(),(n=v.value)==null||n.validate(h=>{if(!h){c.value=!0;try{B("submit",u.value)}catch{}}})},D=()=>{c.value||B("update:show",!1)};return(_,n)=>{const h=j,a=pe,U=F,N=T,V=fe,S=C,L=ve,P=G;return R(),q(P,{show:w.show,"onUpdate:show":n[3]||(n[3]=y=>_.$emit("update:show",y)),"mask-closable":!1},{default:d(()=>[o(L,{title:w.editMode?"编辑组织":"创建组织",style:{width:"600px"}},{footer:d(()=>[o(N,{justify:"end"},{default:d(()=>[o(S,{onClick:D,disabled:c.value},{default:d(()=>n[6]||(n[6]=[I("取消")])),_:1},8,["disabled"]),o(S,{type:"primary",onClick:O,loading:c.value,disabled:c.value},{default:d(()=>[I(ae(w.editMode?"更新":"创建"),1)]),_:1},8,["loading","disabled"])]),_:1})]),default:d(()=>[o(V,{ref_key:"formRef",ref:v,model:u.value,rules:A},{default:d(()=>[o(a,{label:"名称",path:"label"},{default:d(()=>[o(h,{value:u.value.label,"onUpdate:value":n[0]||(n[0]=y=>u.value.label=y),placeholder:"请输入组织名称",disabled:c.value},null,8,["value","disabled"])]),_:1}),o(a,{label:"是否是群组",path:"isGroup"},{default:d(()=>[o(N,null,{default:d(()=>[o(U,{round:!1,value:u.value.isgroup,"onUpdate:value":n[1]||(n[1]=y=>u.value.isgroup=y),disabled:c.value},{checked:d(()=>n[4]||(n[4]=[I(" 是 ")])),unchecked:d(()=>n[5]||(n[5]=[I(" 否 ")])),_:1},8,["value","disabled"])]),_:1})]),_:1}),o(a,{label:"描述",path:"description"},{default:d(()=>[o(h,{value:u.value.description,"onUpdate:value":n[2]||(n[2]=y=>u.value.description=y),type:"textarea",placeholder:"请输入组织描述",disabled:c.value},null,8,["value","disabled"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}},ye={class:"org-form w-full p-2"},ke={class:"mb-2"},Ie={__name:"tree",props:{rangeCheckable:{type:Boolean,default:!1},normal:{type:Boolean,default:!0},checkedKeys:{type:Array,default:()=>[]}},emits:["isEditMode","getOrgKey","orgChecked"],setup(w,{emit:K}){const m=be(),B=p(void 0),v=p(!1),c=p(!1),u=p(!1),A=p(null),O=p(null),D=p(null),_=p(""),n=p(!1),h=K,a=p([]),U=p([]),N=se(()=>{const t=e=>a.value.filter(r=>r.parentId===e).sort((r,f)=>r.orderId-f.orderId).map(r=>{const f={key:r.id,label:r.label,orderId:r.orderId,description:r.description,prefix:()=>b(z,{icon:e==null?"fluent:organization-20-regular":"fluent:organization-28-filled"})},g=t(r.id);return g.length>0&&(f.children=g),f});return t(null)}),V=async()=>{try{await ce.get("/org").then(({data:t})=>{const{status:e,error:s,res:r}=t.value;a.value=r;const f=a.value.filter(g=>g.parentId===null);U.value=f.map(g=>g.id)})}catch{}finally{}},S=({option:t})=>b("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"}},[b("span",{class:"tree-org-name",title:t.label,onClick:()=>Q(t)},t.label),n.value?b(T,{class:"tree-org-actions"},{default:()=>[b(C,{size:"tiny",onClick:e=>{e.stopPropagation(),y(t)}},{default:()=>b(z,{icon:"ri:add-large-fill"})}),b(C,{size:"tiny",onClick:e=>{e.stopPropagation(),W(t)}},{default:()=>b(z,{icon:"ri:delete-bin-6-line"})})]}):null]),L=t=>{h("orgChecked",t)},P=(t,e,s)=>{if(s.node)switch(s.action){case"expand":s.node.prefix=()=>b(z,{icon:"fluent:organization-20-regular"});break;case"collapse":s.node.prefix=()=>b(z,{icon:"fluent:organization-28-filled"});break}},y=t=>{O.value=t.key,v.value=!0},Q=t=>{h("getOrgKey",t.key)},W=t=>{D.value=t.key,u.value=!0},H=t=>{const e={id:a.value.length>0?Math.max(...a.value.map(s=>s.id))+1:1,...t,parentId:O.value,orderId:a.value.filter(s=>s.parentId===O.value).length};a.value.push(e),v.value=!1,m.success("组织创建成功")},J=t=>{const e=a.value.findIndex(s=>s.id===t.id);e!==-1&&(a.value[e]={...a.value[e],...t}),c.value=!1,m.success("组织更新成功")},X=()=>{const t=e=>{a.value=a.value.filter(r=>r.id!==e),a.value.filter(r=>r.parentId===e).forEach(r=>t(r.id))};t(D.value),u.value=!1,m.success("组织删除成功")},Y=t=>{const e=document.querySelectorAll(".tree-org-name");t?(e.forEach(s=>{s.classList.add("edit")}),h("isEditMode",!0)):(e.forEach(s=>{s.classList.remove("edit")}),v.value=!1,c.value=!1,u.value=!1,h("isEditMode",!1))},Z=({node:t,dragNode:e,dropPosition:s})=>{if(!n.value)return;const r=e.key,f=t.key,g=a.value.find(l=>l.id===r),E=a.value.find(l=>l.id===f);try{if(s==="inside")g.parentId=f,g.orderId=e.orderId,a.value.filter(k=>k.parentId===f).forEach((k,$)=>{k.orderId=$});else{g.parentId=E.parentId;const l=a.value.filter(x=>x.parentId===E.parentId);let k;const $=l.findIndex(x=>x.id==f),ee=l.findIndex(x=>x.id==r);s==="after"?k=parseInt($)+1:k=$;const[te]=l.splice(ee,1);l.splice(k,0,te),l.forEach((x,ne)=>{x.orderId=ne})}a.value.sort((l,k)=>l.orderId-k.orderId),m.success("组织结构更新成功")}catch{m.error("组织结构更新失败")}};return re(()=>{V()}),(t,e)=>{const s=F,r=j,f=me,g=_e,E=he;return R(),de("div",ye,[ie("div",ke,[o(i(T),{class:"tree-actions"},{default:d(()=>[o(s,{value:i(n),"onUpdate:value":[e[0]||(e[0]=l=>M(n)?n.value=l:null),Y]},null,8,["value"]),i(n)?(R(),q(i(C),{key:0,onClick:e[1]||(e[1]=l=>v.value=!0)},{default:d(()=>e[7]||(e[7]=[I("创建公司")])),_:1})):ue("",!0)]),_:1}),o(f,{"trigger-top":50,position:"absolute","listen-to":i(B)},{default:d(()=>[o(r,{value:i(_),"onUpdate:value":e[2]||(e[2]=l=>M(_)?_.value=l:null),placeholder:"搜索",clearable:""},null,8,["value"])]),_:1},8,["listen-to"])]),o(g,{style:{"max-height":"100%"},trigger:"hover","y-placementclass":"w-full"},{default:d(()=>[o(i(ge),{data:i(N),"show-irrelevant-nodes":!1,"render-label":S,pattern:i(_),"default-expanded-keys":i(U),draggable:"","expand-on-click":"",checkable:i(n)||w.rangeCheckable,"checked-keys":w.checkedKeys,"onUpdate:checkedKeys":L,onDrop:Z,"on-update:expanded-keys":P,"show-line":"",cascade:""},null,8,["data","pattern","default-expanded-keys","checkable","checked-keys"])]),_:1}),o(E,{show:i(v),"onUpdate:show":e[3]||(e[3]=l=>M(v)?v.value=l:null),"edit-mode":!1,"parent-id":i(O),onSubmit:H},null,8,["show","parent-id"]),o(E,{show:i(c),"onUpdate:show":e[4]||(e[4]=l=>M(c)?c.value=l:null),"edit-mode":!0,organization:i(A),onSubmit:J},null,8,["show","organization"]),o(i(G),{show:i(u),"onUpdate:show":e[6]||(e[6]=l=>M(u)?u.value=l:null),preset:"dialog",title:"确认删除"},{content:d(()=>e[8]||(e[8]=[I("确定要删除该组织吗？此操作将删除该组织及其所有子组织。")])),action:d(()=>[o(i(C),{onClick:e[5]||(e[5]=l=>u.value=!1)},{default:d(()=>e[9]||(e[9]=[I("取消")])),_:1}),o(i(C),{type:"error",onClick:X},{default:d(()=>e[10]||(e[10]=[I("确认删除")])),_:1})]),_:1},8,["show"])])}}},Ne=oe(Ie,[["__scopeId","data-v-1df520d4"]]);export{Ne as _};
